# Affinit-VerticalText-tool
Affinityでの縦書きを実現するためのアプリ
こんなアプリがあったら使えそうだなと思ったので，とりあえずリポジトリだけ作りました。
私生活が忙しくて，しばらく開発に着手できなさそうです。もしご興味がある方がいらっしゃいましたらcontact@kizakuto.comまでメール下さい。
余裕ができたら開発します。たぶん。

以下はChat-GPTといっしょに考えたアプリの仕様書的なものと，開発ロードマップです。
実用的かどうかはわかりませんが，あくまでアプリの理想形です。

# Affinity 縦書き組版補完アプリ 開発引き継ぎ用ドキュメント

---

## 目的
- Affinity に後付けで本格的な縦書き日本語組版機能を実現するアプリの開発引き継ぎ
- 縦書き日本語、カーニング、禁則処理、ルビなどをプロ仕様で対応
- 外部アプリで作成したPDFをAffinityのテキストフレームにリンクとして貼り付け、更新時に自動反映

---

## ワークフロー概要

### STEP 1: Affinityでテキストフレーム作成
- ユーザーがテキストフレームを作る（縦書き機能は未使用）
- フレームをコピー（Ctrl+C）
- コピーされる情報は SVG 形式（フレーム座標、サイズ）

### STEP 2: 外部アプリでフレーム情報取得
- クリップボードのSVGを解析
- フレーム座標、幅・高さ、回転、初期フォント情報を取得

### STEP 3: 外部アプリで縦書きテキスト編集
- 縦組/横組切替
- フォント、ウェイト、文字サイズ（pt/Q）、行間、字間、カーニング設定
- 禁則処理、句読点ぶら下げ、ルビ対応
- 色（ICCプロファイル対応）

### STEP 4: PDF生成
- アウトライン化なし
- CIDフォント埋め込み
- 縦書き情報（WMode 1）
- グリフ座標 + カーニング反映
- ToUnicode + CMap
- ICCプロファイル
- PNGプレビューも生成（Affinity用）

### STEP 5: クリップボード連携
- PDF + PNG を DataObject で複数フォーマットコピー
- テキストフレーム選択 → Ctrl+V でリンクPDF貼り付け
- 必要に応じて SVG 形式も追加

### STEP 6: AffinityでPDFリンク確認
- 貼り付けられたPDFはリンク状態で保持
- プレビュー画像表示、文字選択可能

### STEP 7: リアルタイム更新
- アプリで編集 → PDF再生成 → Affinityが自動更新

### STEP 8: 最終PDF出力
- 組版・カーニング・禁則・縦書き情報を保持して書き出し可能

---

## 技術スタック・ライブラリ

- PDF生成: ReportLab / Cairo / PDFium / PoDoFo / printpdf (Rust) など
- 日本語組版: HarfBuzz + FreeType / Cairo
- クリップボード操作: Windows: DataObject / Win32 API, macOS: NSPasteboard
- プログラミング言語: C#, C++, Python, Rust など

---

## 開発ロードマップ

### フェーズ0: 準備と設計
- Affinityコピー/ペースト仕様確認
- PDF生成ライブラリ選定
- 日本語縦書き組版ライブラリ選定
- 字間・カーニング・禁則仕様整理
- アウトプット仕様書作成

### フェーズ1: 基礎組版エンジン
- 縦書き文字列をPDF描画
- 行間・字間・文字サイズ対応
- カーニング/HarfBuzz GPOS対応
- CIDフォント埋め込み、ToUnicode生成
- 縦書き/横書き切替

### フェーズ2: GUI & 編集機能
- テキスト編集画面
- フォント・ウェイト・サイズ・行間・字間UI
- 禁則処理リアルタイムプレビュー
- 縦書き/横書き切替ボタン
- PDF生成 & PNGプレビュー生成
- リアルタイムプレビュー（オプション）

### フェーズ3: Affinity連携
- PDF + PNG をクリップボードへ同時コピー
- テキストフレーム選択 → Ctrl+V でリンク貼り付け
- PDFリンク保持、プレビュー表示確認
- 外部アプリ編集 → PDF上書き → Affinity自動更新

### フェーズ4: 高度機能
- 自動カーニング（文字間最適化アルゴリズム）
- ルビ対応（縦中横含む）
- 句読点ぶら下げ
- 行頭行末処理
- ICCプロファイル対応
- 長文テキスト高速描画・リアルタイムプレビュー

### フェーズ5: 安定化・配布
- PDF互換性テスト（Affinity, Adobe, Acrobat）
- メモリ・描画最適化
- バグ修正
- Windows/macOSインストーラー作成
- ドキュメント・チュートリアル作成

---

## 注意事項 / 引き継ぎポイント

1. PDF生成時はアウトライン化しないこと（文字選択可能にするため）
2. クリップボード連携では PDF が優先されることを確認
3. PNGはあくまでプレビュー用
4. HarfBuzz/Glyph処理によりAdobe級カーニングを再現
5. 日本語禁則処理やルビは後で追加可能だが、拡張性を考慮して設計
6. 将来的にリアルタイム更新を行う場合は、Affinityのリンク更新機構に依存

---

## 参考資料 / リンク
- Affinity Clipboard挙動の調査結果  
- HarfBuzz / FreeType / Cairo 公式ドキュメント  
- PDF仕様書（ToUnicode, WMode, CIDフォント埋め込み）
- 日本語組版ルール（JIS X 4051）

---

*このドキュメントは、開発を引き継ぐ際に必要な全体像、技術要素、フロー、優先タスクをまとめたものです。*

